<!DOCTYPE html>
<html>
<head>
    <title>전국 연수원 지도</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        #map { 
            height: 600px; 
            width: 100%;
        }
        .popup-content {
            min-width: 200px;
        }
        .rating {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }
        .stars {
            display: flex;
            gap: 5px;
            margin: 5px 0;
        }
        .star {
            cursor: pointer;
            font-size: 20px;
            color: #ccc;
        }
        .star.active {
            color: #ffd700;
        }
        .rating-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .links {
            margin-top: 10px;
        }
        .links a {
            color: #0066cc;
            text-decoration: none;
            margin: 0 5px;
        }
        .links a:hover {
            text-decoration: underline;
        }
        .search-container {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .search-input {
            padding: 8px;
            width: 200px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .search-result-item {
            padding: 8px;
            cursor: pointer;
        }
        .search-result-item:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" class="search-input" placeholder="연수원 검색...">
        <div class="search-results"></div>
    </div>
    <div id="map"></div>

    <!-- Firebase SDK -->
    <script type="module" crossorigin="anonymous">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDSPO1KqZgk1g7Oj7r128FDzrZi0VGcsxw",
            authDomain: "training-centers-map.firebaseapp.com",
            projectId: "training-centers-map",
            storageBucket: "training-centers-map.firebasestorage.app",
            messagingSenderId: "943690141587",
            appId: "1:943690141587:web:1a0bdd995ef6efbf662266"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        console.log("Firebase 초기화 완료");

        // 전역 변수로 마커 저장
        const markers = new Map();

        // 지도 초기화
        const map = L.map('map').setView([36.5, 127.5], 7);
        console.log("지도 초기화 완료");

        // OpenStreetMap 타일 레이어 추가
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // 검색 기능 구현
        function initializeSearch() {
            const searchInput = document.querySelector('.search-input');
            const searchResults = document.querySelector('.search-results');
            let centers = [];

            // 데이터 저장
            async function loadSearchData() {
                const querySnapshot = await getDocs(collection(db, "trainingCenters"));
                centers = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            }

            // 검색 결과 표시
            function showSearchResults(results) {
                searchResults.innerHTML = '';
                if (results.length > 0) {
                    results.forEach(center => {
                        const div = document.createElement('div');
                        div.className = 'search-result-item';
                        div.textContent = `${center.name} (${center.branch})`;
                        div.onclick = () => {
                            const marker = markers.get(center.id);
                            if (marker) {
                                map.setView([center.location.lat, center.location.lng], 13);
                                marker.openPopup();
                            }
                            searchResults.style.display = 'none';
                            searchInput.value = '';
                        };
                        searchResults.appendChild(div);
                    });
                    searchResults.style.display = 'block';
                } else {
                    searchResults.style.display = 'none';
                }
            }

            // 검색 이벤트 처리
            searchInput.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                if (value) {
                    const results = centers.filter(center => 
                        center.name.toLowerCase().includes(value) || 
                        center.branch.toLowerCase().includes(value)
                    );
                    showSearchResults(results);
                } else {
                    searchResults.style.display = 'none';
                }
            });

            // 검색창 외부 클릭 시 결과 숨기기
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    searchResults.style.display = 'none';
                }
            });

            // 초기 데이터 로드
            loadSearchData();
        }

        // 평점 컴포넌트 생성
        function createRatingComponent(center, docId) {
            console.log("평점 컴포넌트 생성:", docId, center);
            const ratingDiv = document.createElement('div');
            ratingDiv.className = 'rating';
            
            const starsDiv = document.createElement('div');
            starsDiv.className = 'stars';
            
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.className = 'star';
                star.innerHTML = '★';
                star.onclick = () => rateCenter(docId, i);
                starsDiv.appendChild(star);
            }
            
            const ratingInfo = document.createElement('div');
            ratingInfo.className = 'rating-info';
            
            // 평점 정보 안전하게 표시
            const average = center.rating && typeof center.rating.average === 'number' ? 
                          Number(center.rating.average).toFixed(1) : '0.0';
            const count = center.rating && typeof center.rating.count === 'number' ? 
                         center.rating.count : 0;
            
            ratingInfo.textContent = `평점: ${average} (${count}명)`;
            
            ratingDiv.appendChild(starsDiv);
            ratingDiv.appendChild(ratingInfo);
            
            return ratingDiv;
        }

        // 평점 부여 함수
        async function rateCenter(centerId, score) {
            console.log("평점 부여:", centerId, score);
            try {
                const centerRef = doc(db, "trainingCenters", centerId);
                const centerDoc = await getDoc(centerRef);
                if (!centerDoc.exists()) {
                    console.error("연수원 문서를 찾을 수 없음:", centerId);
                    return;
                }
                const centerData = centerDoc.data();
                
                const currentRating = centerData.rating || { average: 0, count: 0 };
                const newCount = currentRating.count + 1;
                const newAverage = ((currentRating.average * currentRating.count) + score) / newCount;
                
                await updateDoc(centerRef, {
                    'rating.average': newAverage,
                    'rating.count': newCount
                });

                console.log("평점 업데이트 완료:", newAverage, newCount);

                // UI 업데이트
                const ratingInfo = document.querySelector(`[data-center-id="${centerId}"] .rating-info`);
                if (ratingInfo) {
                    ratingInfo.textContent = `평점: ${newAverage.toFixed(1)} (${newCount}명)`;
                }

                // 별점 UI 업데이트
                const stars = document.querySelectorAll(`[data-center-id="${centerId}"] .star`);
                stars.forEach((star, index) => {
                    if (index < score) {
                        star.classList.add('active');
                    }
                });
            } catch (error) {
                console.error("평점 업데이트 중 에러:", error);
            }
        }

        // 연수원 데이터 로드 및 마커 생성
        async function loadCenters() {
            try {
                console.log("데이터 로드 시작");
                const querySnapshot = await getDocs(collection(db, "trainingCenters"));
                console.log("데이터 가져옴:", querySnapshot.size, "개의 문서");
                
                querySnapshot.forEach((doc) => {
                    const center = doc.data();
                    console.log("연수원 데이터:", center);

                    if (!center.location || !center.location.lat || !center.location.lng) {
                        console.error("위치 정보 없음:", doc.id);
                        return;
                    }

                    const marker = L.circleMarker([center.location.lat, center.location.lng], {
                        radius: getMarkerRadius(map.getZoom()),
                        fillColor: '#ff3333',    // 빨간색으로 변경
                        color: "#000",          // 테두리 색상
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    // 마커 저장
                    markers.set(doc.id, marker);

                    // 팝업 콘텐츠 생성
                    const popupContent = document.createElement('div');
                    popupContent.className = 'popup-content';
                    popupContent.setAttribute('data-center-id', doc.id);
                    
                    popupContent.innerHTML = `
                        <h3>${center.name || '이름 없음'}</h3>
                        <p>${center.branch || '위치 정보 없음'}</p>
                        <p>${center.basicInfo || '정보 없음'}</p>
                        <div class="links">
                            <a href="${center.links?.naver || '#'}" target="_blank">네이버 지도</a> | 
                            <a href="${center.links?.website || '#'}" target="_blank">웹사이트</a>
                        </div>
                    `;

                    // 평점 컴포넌트 추가
                    const ratingComponent = createRatingComponent(center, doc.id);
                    popupContent.appendChild(ratingComponent);

                    marker.bindPopup(popupContent);
                    console.log("마커 및 팝업 생성 완료:", doc.id);
                });

                // 검색 기능 초기화
                initializeSearch();
            } catch (error) {
                console.error("데이터 로드 중 에러:", error);
            }
        }

        // 초기 데이터 로드
        loadCenters().catch(console.error);
    </script>
</body>
</html>
